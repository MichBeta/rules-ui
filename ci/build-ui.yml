platform: linux

image_resource:
  type: docker-image
  source:
    repository: feeds.axadmin.net/docker/library/node
    tag: "20"
    username: ((proget-user))
    password: ((proget-password))

inputs:
  - name: source-git
outputs:
  - name: artifact
  - name: versions
  - name: source-git
run:
  dir: source-git
  path: bash
  args:
    - -exc
    - |
      # Format the version
      version=$(git describe --long | awk -F- '{printf "V%s-%04d-%s", $1, $2, $3}')_dev
      echo $version > ./ci/version.txt

      # Define directories
      repo_dir=${PWD}
      parentdir="$(dirname "${repo_dir}")"
      output_directory=${parentdir}/artifact
      version_directory=${parentdir}/versions

      # Create the output directories
      mkdir -p ${output_directory}
      mkdir -p ${version_directory}

      # Copy version file to the versions output
      cp ./ci/version.txt ${version_directory}/
        
#      apt-get update
      npm install
      export PATH="./node_modules/.bin/:$PATH"
      
      npm run build
      
      cp -R "dist/novo/"* $output_directory
      cd $output_directory
#      # Build Docker image
#      docker build -t feeds.axadmin.net/docker/rms/nvcmp/rules-newui:${version} .
#
#      # Push Docker image
#      docker push feeds.axadmin.net/docker/rms/nvcmp/rules-newui:${version}
#
#      # Optionally: tag the image as 'latest' and push
#      docker tag feeds.axadmin.net/docker/rms/nvcmp/rules-newui:${version} feeds.axadmin.net/docker/rms/nvcmp/rules-newui:latest
#      docker push feeds.axadmin.net/docker/rms/nvcmp/rules-newui:latest

      # Copy necessary files to the artifact output
#      cp -r . ${output_directory}/