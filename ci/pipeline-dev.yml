groups:
  - name: dev
    jobs:
      - display-config
      - build-rules-newui
      - deploy-dev
  - name: qa
    jobs:
      - deploy-qa
jobs:
  - name: display-config
    plan:
      - task: print-git-uri
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: { repository: busybox }
          params:
            GIT_URI: ((git-uri))
            PROJECT_KEY: ((project_key))
            PROJECT_NAME: ((project_name))
          run:
            path: sh
            args:
              - -c
              - |
                echo "The GIT_URI is $GIT_URI"
                echo "The PROJECT_KEY is $PROJECT_KEY"
                echo "The PROJECT_NAME is $PROJECT_NAME"
  - name: build-rules-newui
    plan:
      - in_parallel:
          - get: source-git
            trigger: true
      - file: source-git/ci/build-ui.yml
        params:
          environment: dev
          file_prefix: ((project_key))
          proget_password: ((proget-password))
          proget_username: ((proget-user))
          project_name: ((project_name))
        task: build-rules-newui
      - params:
          build: ./
          dockerfile: source-git/ci/docker/rulesui-dockerfile
          tag_as_latest: true
          tag_file: build-output/version.txt
        put: docker-nvcmp-rules-newui
  - name: deploy-dev
    plan:
      - get: docker-nvcmp-rules-newui
      - get: source-git
        passed:
          - build-rules-newui
        trigger: true
      - task: prepare-k8s
        image: docker-nvcmp-rules-newui
        config:
          platform: linux
          inputs:
            - name: source-git
          outputs:
            - name: source-git
          run:
            path: bash
            args:
              - -exc
              - |
                set -x
                apt-get update
                apt-get install -y git
                cd source-git
                DOCKER_TAG=$(git describe | awk -F- '{printf "V%s-%04d-%s", $1, $2, $3}')
                sed -i "s/:VERSION/:$DOCKER_TAG/" ci/k8s/dev/deployment.yaml
                cat ci/k8s/dev/deployment.yaml | grep "image:"
      - put: kubectl-deploy-dev
        params:
          file: source-git/ci/k8s/dev
          path: deployables
  - name: deploy-qa
    plan:
      - get: docker-nvcmp-rules-newui
      - get: source-git
        passed:
          - build-rules-newui
        trigger: false
      - task: prepare-k8s
        image: docker-nvcmp-rules-newui
        config:
          platform: linux
          inputs:
            - name: source-git
          outputs:
            - name: source-git
          run:
            path: bash
            args:
              - -exc
              - |
                set -x
                apt-get update
                apt-get install -y git
                cd source-git
                DOCKER_TAG=$(git describe | awk -F- '{printf "V%s-%04d-%s", $1, $2, $3}')
                sed -i "s/:VERSION/:$DOCKER_TAG/" ci/k8s/qae/deployment.yaml
                cat ci/k8s/qae/deployment.yaml | grep "image:"
      - put: kubectl-deploy-qae
        params:
          file: source-git/ci/k8s/qae
          path: deployables
resource_types:
  - name: concourse-kubectl
    type: docker-image
    source:
      password: ((proget-password))
      repository: ((proget-url))/docker/gito/concourse-kubectl-resource
      tag: latest
      username: ((proget-user))
resources:
  - name: docker-nvcmp-rules-newui
    type: docker-image
    icon: docker
    source:
      password: ((proget-password))
      repository: feeds.axadmin.net/docker/rms/nvcmp/rules-newui
      tag: latest
      username: ((proget-user))
  - name: kubectl-deploy-dev
    type: concourse-kubectl
    icon: kubernetes
    source:
      api_server_uri: ((dev-cluster.api-server))
      certificate_authority_data: ((dev-cluster.ca))
      namespace: rms-dev-nvcmp
      token: ((dev-cluster.token))
  - name: kubectl-deploy-qae
    type: concourse-kubectl
    icon: kubernetes
    source:
      api_server_uri: ((qae-cluster.api-server))
      certificate_authority_data: ((qae-cluster.ca))
      namespace: rms-qae-nvcmp
      token: ((qae-cluster.token))
  - name: source-git
    type: git
    icon: bitbucket
    source:
      branch: tanzu-dev
      private_key: ((novoCompliance.private-repo-key-ui))
      uri: git@bitbucket.org:SoleraNA/rules-newui.git
